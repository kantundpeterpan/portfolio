<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Heiner Atze">

<title>PostgreSQL Summary Stats and Window functions – Heiner Atze, PhD</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
<link rel="stylesheet" href="../../dc_course.css">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-window-functions" id="toc-introduction-to-window-functions" class="nav-link active" data-scroll-target="#introduction-to-window-functions">Introduction to window functions</a>
  <ul class="collapse">
  <li><a href="#numbering-rows" id="toc-numbering-rows" class="nav-link" data-scroll-target="#numbering-rows">Numbering rows</a></li>
  <li><a href="#number-olympic-games-in-ascending-order" id="toc-number-olympic-games-in-ascending-order" class="nav-link" data-scroll-target="#number-olympic-games-in-ascending-order">Number Olympic Games in ascending order</a></li>
  <li><a href="#numbering-olympic-games-in-descending-order" id="toc-numbering-olympic-games-in-descending-order" class="nav-link" data-scroll-target="#numbering-olympic-games-in-descending-order">Numbering Olympic games in descending order</a></li>
  <li><a href="#numbering-of-olympic-athletes-by-medals-earned" id="toc-numbering-of-olympic-athletes-by-medals-earned" class="nav-link" data-scroll-target="#numbering-of-olympic-athletes-by-medals-earned">Numbering of Olympic athletes by medals earned</a></li>
  <li><a href="#reigning-weightlifiting-champions" id="toc-reigning-weightlifiting-champions" class="nav-link" data-scroll-target="#reigning-weightlifiting-champions">Reigning weightlifiting champions</a></li>
  <li><a href="#partition-by---reigning-champions-by-gender" id="toc-partition-by---reigning-champions-by-gender" class="nav-link" data-scroll-target="#partition-by---reigning-champions-by-gender">PARTITION BY - Reigning champions by gender</a></li>
  <li><a href="#partition-by-multiple-columns---reigning-champions-by-gender-and-event" id="toc-partition-by-multiple-columns---reigning-champions-by-gender-and-event" class="nav-link" data-scroll-target="#partition-by-multiple-columns---reigning-champions-by-gender-and-event">PARTITION BY multiple columns - Reigning champions by gender and event</a></li>
  </ul></li>
  <li><a href="#fetching-ranking-and-paging" id="toc-fetching-ranking-and-paging" class="nav-link" data-scroll-target="#fetching-ranking-and-paging">Fetching, Ranking and paging</a>
  <ul class="collapse">
  <li><a href="#future-gold-medalists" id="toc-future-gold-medalists" class="nav-link" data-scroll-target="#future-gold-medalists">Future gold medalists</a></li>
  <li><a href="#first-athlete-by-name" id="toc-first-athlete-by-name" class="nav-link" data-scroll-target="#first-athlete-by-name">First athlete by name</a></li>
  <li><a href="#last-country-by-name" id="toc-last-country-by-name" class="nav-link" data-scroll-target="#last-country-by-name">Last country by name</a></li>
  <li><a href="#ranking-athletes-by-medals-earned" id="toc-ranking-athletes-by-medals-earned" class="nav-link" data-scroll-target="#ranking-athletes-by-medals-earned">Ranking athletes by medals earned</a></li>
  <li><a href="#ranking-athletes-from-multiple-countries" id="toc-ranking-athletes-from-multiple-countries" class="nav-link" data-scroll-target="#ranking-athletes-from-multiple-countries">Ranking athletes from multiple countries</a></li>
  <li><a href="#paging" id="toc-paging" class="nav-link" data-scroll-target="#paging">PAGING</a></li>
  <li><a href="#top-middle-and-top-thirds" id="toc-top-middle-and-top-thirds" class="nav-link" data-scroll-target="#top-middle-and-top-thirds">Top, middle and top thirds</a></li>
  </ul></li>
  <li><a href="#aggregate-window-functions" id="toc-aggregate-window-functions" class="nav-link" data-scroll-target="#aggregate-window-functions">Aggregate window functions</a>
  <ul class="collapse">
  <li><a href="#running-total-of-athlete-medals" id="toc-running-total-of-athlete-medals" class="nav-link" data-scroll-target="#running-total-of-athlete-medals">Running total of athlete medals</a></li>
  <li><a href="#running-maximum-no.-of-medals-per-country" id="toc-running-maximum-no.-of-medals-per-country" class="nav-link" data-scroll-target="#running-maximum-no.-of-medals-per-country">Running maximum no. of medals per country</a></li>
  <li><a href="#running-minimum-number-of-medals" id="toc-running-minimum-number-of-medals" class="nav-link" data-scroll-target="#running-minimum-number-of-medals">Running minimum number of medals</a></li>
  <li><a href="#frames-for-windows-functions" id="toc-frames-for-windows-functions" class="nav-link" data-scroll-target="#frames-for-windows-functions">FRAMES for windows functions</a></li>
  <li><a href="#moving-average" id="toc-moving-average" class="nav-link" data-scroll-target="#moving-average">Moving average</a></li>
  <li><a href="#partitioned-moving-total" id="toc-partitioned-moving-total" class="nav-link" data-scroll-target="#partitioned-moving-total">Partitioned Moving Total</a></li>
  </ul></li>
  <li><a href="#pivoting" id="toc-pivoting" class="nav-link" data-scroll-target="#pivoting">Pivoting</a>
  <ul class="collapse">
  <li><a href="#basic-pivot" id="toc-basic-pivot" class="nav-link" data-scroll-target="#basic-pivot">Basic pivot</a></li>
  <li><a href="#pivot-with-ranking" id="toc-pivot-with-ranking" class="nav-link" data-scroll-target="#pivot-with-ranking">Pivot with ranking</a></li>
  </ul></li>
  <li><a href="#include-totals-and-grand-totals---rollup-and-cube" id="toc-include-totals-and-grand-totals---rollup-and-cube" class="nav-link" data-scroll-target="#include-totals-and-grand-totals---rollup-and-cube">Include Totals and Grand Totals - ROLLUP and CUBE</a>
  <ul class="collapse">
  <li><a href="#rollup" id="toc-rollup" class="nav-link" data-scroll-target="#rollup">ROLLUP</a></li>
  <li><a href="#cube" id="toc-cube" class="nav-link" data-scroll-target="#cube">CUBE</a></li>
  </ul></li>
  <li><a href="#replace-nulls" id="toc-replace-nulls" class="nav-link" data-scroll-target="#replace-nulls">Replace nulls</a></li>
  <li><a href="#compressing-query-output" id="toc-compressing-query-output" class="nav-link" data-scroll-target="#compressing-query-output">Compressing Query output</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PostgreSQL Summary Stats and Window functions</h1>
<p class="subtitle lead">Course notebook</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Heiner Atze </p>
          </div>
  </div>
    
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    Resulting tables are trimmed for clarity using the <code>LIMIT 2</code> clause
  </div>
</div>


</header>


<section id="introduction-to-window-functions" class="level1 page-columns page-full">
<h1>Introduction to window functions</h1>
<section id="numbering-rows" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="numbering-rows">Numbering rows</h2>
<p>
The simplest application for window functions is numbering rows. Numbering rows allows you to easily fetch the <code>n</code>th row. For example, it would be very difficult to get the 35th row in any given table if you didn’t have a column with each row’s number.
</p>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Number each row in the dataset.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Assign numbers to each row</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>() <span class="kw">AS</span> Row_N</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Row_N <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
city
</th>
<th>
sport
</th>
<th>
discipline
</th>
<th>
athlete
</th>
<th>
country
</th>
<th>
gender
</th>
<th>
event
</th>
<th>
medal
</th>
<th>
row_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1896
</td>
<td>
Athens
</td>
<td>
Aquatics
</td>
<td>
Swimming
</td>
<td>
HAJOS Alfred
</td>
<td>
HUN
</td>
<td>
Men
</td>
<td>
100M Freestyle
</td>
<td>
Gold
</td>
<td>
1
</td>
</tr>
<tr>
<td>
1896
</td>
<td>
Athens
</td>
<td>
Aquatics
</td>
<td>
Swimming
</td>
<td>
HERSCHMANN Otto
</td>
<td>
AUT
</td>
<td>
Men
</td>
<td>
100M Freestyle
</td>
<td>
Silver
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
</section>
<section id="number-olympic-games-in-ascending-order" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="number-olympic-games-in-ascending-order">Number Olympic Games in ascending order</h2>
<div class="css-alxior">
<div>
<p>
The Summer Olympics dataset contains the results of the games between 1896 and 2012. The first Summer Olympics were held in 1896, the second in 1900, and so on. What if you want to easily query the table to see in which year the 13th Summer Olympics were held? You’d need to number the rows for that.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Assign a number to each year in which Summer Olympic games were held.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb2"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Assign numbers to each year</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>() <span class="kw">AS</span> Row_N</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="dt">year</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> Years</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
row_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1896
</td>
<td>
1
</td>
</tr>
<tr>
<td>
1900
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
</section>
<section id="numbering-olympic-games-in-descending-order" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="numbering-olympic-games-in-descending-order">Numbering Olympic games in descending order</h2>
<div class="css-alxior">
<div>
<p>
You’ve already numbered the rows in the Summer Medals dataset. What if you need to reverse the row numbers so that the most recent Olympic games’ rows have a lower number?
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Assign a number to each year in which Summer Olympic games were held so that rows with the most recent years have lower row numbers.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Assign the lowest numbers to the most recent years</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">DESC</span>) <span class="kw">AS</span> Row_N</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="dt">Year</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> Years</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
row_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1896
</td>
<td>
27
</td>
</tr>
<tr>
<td>
1900
</td>
<td>
26
</td>
</tr>
</tbody>
</table>
</section>
<section id="numbering-of-olympic-athletes-by-medals-earned" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="numbering-of-olympic-athletes-by-medals-earned">Numbering of Olympic athletes by medals earned</h2>
<div class="css-alxior">
<div>
<p>
Row numbering can also be used for ranking. For example, numbering rows and ordering by the count of medals each athlete earned in the OVER clause will assign 1 to the highest-earning medalist, 2 to the second highest-earning medalist, and so on.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
For each athlete, count the number of medals he or she has earned.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Count the number of medals each athlete has earned</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  athlete,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(athlete) <span class="kw">AS</span> Medals</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> Athlete</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
PHELPS Michael
</td>
<td>
22
</td>
</tr>
<tr>
<td>
LATYNINA Larisa
</td>
<td>
18
</td>
</tr>
</tbody>
</table>
<hr>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Having wrapped the previous query in the <code>Athlete_Medals</code> CTE, rank each athlete by the number of medals they’ve earned.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athlete_Medals <span class="kw">AS</span> (</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Count the number of medals each athlete has earned</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    Athlete,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Athlete)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Number each athlete by how many medals they've earned</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  athlete,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> medals <span class="kw">DESC</span>) <span class="kw">AS</span> Row_N</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Athlete_Medals</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
row_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
PHELPS Michael
</td>
<td>
1
</td>
</tr>
<tr>
<td>
LATYNINA Larisa
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
</section>
<section id="reigning-weightlifiting-champions" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="reigning-weightlifiting-champions">Reigning weightlifiting champions</h2>
<div class="css-alxior">
<div>
<p>
A reigning champion is a champion who’s won both the previous and current years’ competitions. To determine if a champion is reigning, the previous and current years’ results need to be in the same row, in two different columns.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return each year’s gold medalists in the Men’s 69KG weightlifting competition.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Return each year's champions' countries</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  country <span class="kw">AS</span> champion</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  Discipline <span class="op">=</span> <span class="st">'Weightlifting'</span> <span class="kw">AND</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  Event <span class="op">=</span> <span class="st">'69KG'</span> <span class="kw">AND</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  Gender <span class="op">=</span> <span class="st">'Men'</span> <span class="kw">AND</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  Medal <span class="op">=</span> <span class="st">'Gold'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
champion
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
2000
</td>
<td>
BUL
</td>
</tr>
<tr>
<td>
2004
</td>
<td>
CHN
</td>
</tr>
<tr>
<td>
2008
</td>
<td>
CHN
</td>
</tr>
<tr>
<td>
2012
</td>
<td>
CHN
</td>
</tr>
</tbody>
</table>
<hr>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Having wrapped the previous query in the <code>Weightlifting_Gold</code> CTE, get the previous year’s champion for each year.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Weightlifting_Gold <span class="kw">AS</span> (</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Return each year's champions' countries</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    Country <span class="kw">AS</span> champion</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    Discipline <span class="op">=</span> <span class="st">'Weightlifting'</span> <span class="kw">AND</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    Event <span class="op">=</span> <span class="st">'69KG'</span> <span class="kw">AND</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    Gender <span class="op">=</span> <span class="st">'Men'</span> <span class="kw">AND</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    Medal <span class="op">=</span> <span class="st">'Gold'</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span>, Champion,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Fetch the previous year's champion</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Lag</span>(Champion) <span class="kw">OVER</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ASC</span>) <span class="kw">AS</span> Last_Champion</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Weightlifting_Gold</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
champion
</th>
<th>
last_champion
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
2000
</td>
<td>
BUL
</td>
<td>
null
</td>
</tr>
<tr>
<td>
2004
</td>
<td>
CHN
</td>
<td>
BUL
</td>
</tr>
<tr>
<td>
2008
</td>
<td>
CHN
</td>
<td>
CHN
</td>
</tr>
<tr>
<td>
2012
</td>
<td>
CHN
</td>
<td>
CHN
</td>
</tr>
</tbody>
</table>
</section>
<section id="partition-by---reigning-champions-by-gender" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="partition-by---reigning-champions-by-gender">PARTITION BY - Reigning champions by gender</h2>
<div class="css-alxior">
<div>
<p>
You’ve already fetched the previous year’s champion for one event. However, if you have multiple events, genders, or other metrics as columns, you’ll need to split your table into partitions to avoid having a champion from one event or gender appear as the previous champion of another event or gender.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the previous champions of each year’s event by gender.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Tennis_Gold <span class="kw">AS</span> (</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    Gender, <span class="dt">Year</span>, Country</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span> <span class="kw">AND</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    Event <span class="op">=</span> <span class="st">'Javelin Throw'</span> <span class="kw">AND</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    Medal <span class="op">=</span> <span class="st">'Gold'</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  Gender, <span class="dt">Year</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  Country <span class="kw">AS</span> Champion,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Fetch the previous year's champion by gender</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">LAG</span>(Country) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> Gender</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>) <span class="kw">AS</span> Last_Champion</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Tennis_Gold</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Gender <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
gender
</th>
<th>
year
</th>
<th>
champion
</th>
<th>
last_champion
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Men
</td>
<td>
2000
</td>
<td>
CZE
</td>
<td>
null
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2004
</td>
<td>
NOR
</td>
<td>
CZE
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2008
</td>
<td>
NOR
</td>
<td>
NOR
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2012
</td>
<td>
TTO
</td>
<td>
NOR
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2000
</td>
<td>
NOR
</td>
<td>
null
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2004
</td>
<td>
CUB
</td>
<td>
NOR
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2008
</td>
<td>
CZE
</td>
<td>
CUB
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2012
</td>
<td>
CZE
</td>
<td>
CZE
</td>
</tr>
</tbody>
</table>
</section>
<section id="partition-by-multiple-columns---reigning-champions-by-gender-and-event" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="partition-by-multiple-columns---reigning-champions-by-gender-and-event">PARTITION BY multiple columns - Reigning champions by gender and event</h2>
<div class="css-alxior">
<div>
<p>
In the previous exercise, you partitioned by gender to ensure that data about one gender doesn’t get mixed into data about the other gender. If you have multiple columns, however, partitioning by only one of them will still mix the results of the other columns.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the previous champions of each year’s events by gender and event.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athletics_Gold <span class="kw">AS</span> (</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    Gender, <span class="dt">Year</span>, Event, Country</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span> <span class="kw">AND</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    Discipline <span class="op">=</span> <span class="st">'Athletics'</span> <span class="kw">AND</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    Event <span class="kw">IN</span> (<span class="st">'100M'</span>, <span class="st">'10000M'</span>) <span class="kw">AND</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    Medal <span class="op">=</span> <span class="st">'Gold'</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  Gender, <span class="dt">Year</span>, Event,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  Country <span class="kw">AS</span> Champion,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Fetch the previous year's champion by gender and event</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">LAG</span>(Country) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> Gender, Event</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>) <span class="kw">AS</span> Last_Champion</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Athletics_Gold</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Event <span class="kw">ASC</span>, Gender <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
gender
</th>
<th>
year
</th>
<th>
event
</th>
<th>
champion
</th>
<th>
last_champion
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Men
</td>
<td>
2000
</td>
<td>
10000M
</td>
<td>
ETH
</td>
<td>
null
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2004
</td>
<td>
10000M
</td>
<td>
ETH
</td>
<td>
ETH
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2008
</td>
<td>
10000M
</td>
<td>
ETH
</td>
<td>
ETH
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2012
</td>
<td>
10000M
</td>
<td>
GBR
</td>
<td>
ETH
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2000
</td>
<td>
10000M
</td>
<td>
ETH
</td>
<td>
null
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2004
</td>
<td>
10000M
</td>
<td>
CHN
</td>
<td>
ETH
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2008
</td>
<td>
10000M
</td>
<td>
ETH
</td>
<td>
CHN
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2012
</td>
<td>
10000M
</td>
<td>
ETH
</td>
<td>
ETH
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2000
</td>
<td>
100M
</td>
<td>
USA
</td>
<td>
null
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2004
</td>
<td>
100M
</td>
<td>
USA
</td>
<td>
USA
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2008
</td>
<td>
100M
</td>
<td>
JAM
</td>
<td>
USA
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
2012
</td>
<td>
100M
</td>
<td>
JAM
</td>
<td>
JAM
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2004
</td>
<td>
100M
</td>
<td>
BLR
</td>
<td>
null
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2008
</td>
<td>
100M
</td>
<td>
JAM
</td>
<td>
BLR
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
2012
</td>
<td>
100M
</td>
<td>
JAM
</td>
<td>
JAM
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="fetching-ranking-and-paging" class="level1 page-columns page-full">
<h1>Fetching, Ranking and paging</h1>
<section id="future-gold-medalists" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="future-gold-medalists">Future gold medalists</h2>
<div class="css-alxior">
<div>
<p>
Fetching functions allow you to get values from different parts of the table into one row. If you have time-ordered data, you can “peek into the future” with the <code>LEAD</code> fetching function. This is especially useful if you want to compare a current value to a future value.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
For each year, fetch the current gold medalist and the gold medalist 3 competitions ahead of the current row.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Discus_Medalists <span class="kw">AS</span> (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    Athlete</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Event <span class="op">=</span> <span class="st">'Discus Throw'</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Gender <span class="op">=</span> <span class="st">'Women'</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- For each year, fetch the current and future medalists</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  athlete,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">LEAD</span>(athlete,<span class="dv">3</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ASC</span>) <span class="kw">AS</span> Future_Champion</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Discus_Medalists</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
athlete
</th>
<th>
future_champion
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
2000
</td>
<td>
ZVEREVA Ellina
</td>
<td>
PERKOVIC Sandra
</td>
</tr>
<tr>
<td>
2004
</td>
<td>
SADOVA Natalya
</td>
<td>
null
</td>
</tr>
<tr>
<td>
2008
</td>
<td>
BROWN TRAFTON Stephanie
</td>
<td>
null
</td>
</tr>
<tr>
<td>
2012
</td>
<td>
PERKOVIC Sandra
</td>
<td>
null
</td>
</tr>
</tbody>
</table>
</section>
<section id="first-athlete-by-name" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="first-athlete-by-name">First athlete by name</h2>
<div class="css-alxior">
<div>
<p>
It’s often useful to get the first or last value in a dataset to compare all other values to it. With absolute fetching functions like <code>FIRST_VALUE</code>, you can fetch a value at an absolute position in the table, like its beginning or end.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return all athletes and the first athlete ordered by alphabetical order.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> All_Male_Medalists <span class="kw">AS</span> (</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    Athlete</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Gender <span class="op">=</span> <span class="st">'Men'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Fetch all athletes and the first athlete alphabetically</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  Athlete,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FIRST_VALUE</span>(athlete) <span class="kw">OVER</span> (</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> athlete <span class="kw">ASC</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">AS</span> First_Athlete</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> All_Male_Medalists;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
first_athlete
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
AABYE Edgar
</td>
<td>
AABYE Edgar
</td>
</tr>
<tr>
<td>
AALTONEN Paavo Johannes
</td>
<td>
AABYE Edgar
</td>
</tr>
<tr>
<td>
AAS Thomas Valentin
</td>
<td>
AABYE Edgar
</td>
</tr>
</tbody>
</table>
</section>
<section id="last-country-by-name" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="last-country-by-name">Last country by name</h2>
<div class="css-alxior">
<div>
<p>
Just like you can get the first row’s value in a dataset, you can get the last row’s value. This is often useful when you want to compare the most recent value to previous values.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the year and the city in which each Olympic games were held.
</li>
<li>
Fetch the last city in which the Olympic games were held.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb12"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Hosts <span class="kw">AS</span> (</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="dt">Year</span>, City</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> Summer_Medals)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  City,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Get the last city in which the Olympic games were held</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">LAST_VALUE</span>(City) <span class="kw">OVER</span> (</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">RANGE</span> <span class="kw">BETWEEN</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>     <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>     <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">AS</span> Last_City</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Hosts</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
city
</th>
<th>
last_city
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1896
</td>
<td>
Athens
</td>
<td>
London
</td>
</tr>
<tr>
<td>
1900
</td>
<td>
Paris
</td>
<td>
London
</td>
</tr>
</tbody>
</table>
</section>
<section id="ranking-athletes-by-medals-earned" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="ranking-athletes-by-medals-earned">Ranking athletes by medals earned</h2>
<div class="css-alxior">
<div>
<p>
In chapter 1, you used <code>ROW_NUMBER</code> to rank athletes by awarded medals. However, <code>ROW_NUMBER</code> assigns different numbers to athletes with the same count of awarded medals, so it’s not a useful ranking function; if two athletes earned the same number of medals, they should have the same rank.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Rank each athlete by the number of medals they’ve earned – the higher the count, the higher the rank – with identical numbers in case of identical values.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb13"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athlete_Medals <span class="kw">AS</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    Athlete,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Athlete)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  Athlete,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  Medals,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Rank athletes by the medals they've won</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> medals <span class="kw">DESC</span>) <span class="kw">AS</span> Rank_N</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Athlete_Medals</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
medals
</th>
<th>
rank_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
PHELPS Michael
</td>
<td>
22
</td>
<td>
1
</td>
</tr>
<tr>
<td>
LATYNINA Larisa
</td>
<td>
18
</td>
<td>
2
</td>
</tr>
<tr>
<td>
ANDRIANOV Nikolay
</td>
<td>
15
</td>
<td>
3
</td>
</tr>
</tbody>
</table>
</section>
<section id="ranking-athletes-from-multiple-countries" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="ranking-athletes-from-multiple-countries">Ranking athletes from multiple countries</h2>
<div class="css-alxior">
<div>
<p>
In the previous exercise, you used <code>RANK</code> to assign rankings to one group of athletes. In real-world data, however, you’ll often find numerous groups within your data. Without partitioning your data, one group’s values will influence the rankings of the others.
</p>
<p>
Also, while <code>RANK</code> skips numbers in case of identical values, the most natural way to assign rankings is not to skip numbers. If two countries are tied for second place, the country after them is considered to be third by most people.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Rank each country’s athletes by the count of medals they’ve earned – the higher the count, the higher the rank – without skipping numbers in case of identical values.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athlete_Medals <span class="kw">AS</span> (</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    Country, Athlete, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">--for clearer output</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> Country</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">DESC</span>) <span class="kw">as</span> row_n</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    Country <span class="kw">IN</span> (<span class="st">'JPN'</span>, <span class="st">'KOR'</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Country, Athlete</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  Country,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Rank athletes in each country by the medals they've won</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  athlete,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">DENSE_RANK</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> country</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                <span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>) <span class="kw">AS</span> Rank_N</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Athlete_Medals</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">--for clearer output</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> row_n <span class="op">&lt;</span> <span class="dv">4</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, RANK_N <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
athlete
</th>
<th>
rank_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
JPN
</td>
<td>
KITAJIMA Kosuke
</td>
<td>
1
</td>
</tr>
<tr>
<td>
JPN
</td>
<td>
UCHIMURA Kohei
</td>
<td>
2
</td>
</tr>
<tr>
<td>
JPN
</td>
<td>
TAKEDA Miho
</td>
<td>
3
</td>
</tr>
<tr>
<td>
KOR
</td>
<td>
JIN Jongoh
</td>
<td>
1
</td>
</tr>
<tr>
<td>
KOR
</td>
<td>
PARK Taehwan
</td>
<td>
2
</td>
</tr>
<tr>
<td>
KOR
</td>
<td>
PARK Sung-Hyun
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
</section>
<section id="paging" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="paging">PAGING</h2>
<div class="css-alxior">
<div>
<p>
There are exactly 666 unique events in the Summer Medals Olympics dataset. If you want to chunk them up to analyze them piece by piece, you’ll need to split the events into groups of approximately equal size.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Split the distinct events into exactly 111 groups, ordered by event in alphabetical order.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb15"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> <span class="kw">Events</span> <span class="kw">AS</span> (</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> Event</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">--- Split up the distinct events into 111 unique groups</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  event,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NTILE</span>(<span class="dv">111</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> event <span class="kw">ASC</span>) <span class="kw">AS</span> Page</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">Events</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Event <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
event
</th>
<th>
page
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<ul>
<li>100KG
</li></ul></td>
<td>
1
</td>
</tr>
<tr>
<td>
<ul>
<li>100KG (Heavyweight)
</li></ul></td>
<td>
1
</td>
</tr>
<tr>
<td>
<ul>
<li>100KG (Super Heavyweight)
</li></ul></td>
<td>
1
</td>
</tr>
</tbody>
</table>



</section>
<section id="top-middle-and-top-thirds" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="top-middle-and-top-thirds">Top, middle and top thirds</h2>
<div class="css-alxior">
<div>
<p>
Splitting your data into thirds or quartiles is often useful to understand how the values in your dataset are spread. Getting summary statistics (averages, sums, standard deviations, <em>etc.</em>) of the top, middle, and bottom thirds can help you determine what distribution your values follow.
</p>
</div>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Split the athletes into top, middle, and bottom thirds based on their count of medals.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athlete_Medals <span class="kw">AS</span> (</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> Athlete, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Athlete</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  Athlete,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  Medals,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Split athletes into thirds by their earned medals</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NTILE</span>(<span class="dv">3</span>) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> medals <span class="kw">DESC</span>) <span class="kw">AS</span> Third</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Athlete_Medals</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>, Athlete <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
medals
</th>
<th>
third
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
PHELPS Michael
</td>
<td>
22
</td>
<td>
1
</td>
</tr>
<tr>
<td>
LATYNINA Larisa
</td>
<td>
18
</td>
<td>
1
</td>
</tr>
<tr>
<td>
ANDRIANOV Nikolay
</td>
<td>
15
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the average of each third.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athlete_Medals <span class="kw">AS</span> (</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> Athlete, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Athlete</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">1</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  Thirds <span class="kw">AS</span> (</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    Athlete,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    Medals,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">NTILE</span>(<span class="dv">3</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>) <span class="kw">AS</span> Third</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Athlete_Medals)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Get the average medals earned in each third</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  third,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(medals) <span class="kw">AS</span> Avg_Medals</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Thirds</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> Third</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Third <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
third
</th>
<th>
avg_medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1
</td>
<td>
3.7864464692482916
</td>
</tr>
<tr>
<td>
2
</td>
<td>
2.0000000000000000
</td>
</tr>
<tr>
<td>
3
</td>
<td>
2.0000000000000000
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="aggregate-window-functions" class="level1 page-columns page-full">
<h1>Aggregate window functions</h1>
<section id="running-total-of-athlete-medals" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="running-total-of-athlete-medals">Running total of athlete medals</h2>
<div>
<p>
The running total (or cumulative sum) of a column helps you determine what each row’s contribution is to the total sum.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the athletes, the number of medals they earned, and the medals running total, ordered by the athletes’ names in alphabetical order.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb18"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Athlete_Medals <span class="kw">AS</span> (</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    Athlete, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    Country <span class="op">=</span> <span class="st">'USA'</span> <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Athlete)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Calculate the running total of athlete medals</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  Athlete,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  Medals,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(Medals) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> Athlete <span class="kw">ASC</span>) <span class="kw">AS</span> Max_Medals</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Athlete_Medals</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Athlete <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
medals
</th>
<th>
max_medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
ABDUR-RAHIM Shareef
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
ABERNATHY Brent
</td>
<td>
1
</td>
<td>
2
</td>
</tr>
<tr>
<td>
ADRIAN Nathan
</td>
<td>
3
</td>
<td>
5
</td>
</tr>
</tbody>
</table>
</section>
<section id="running-maximum-no.-of-medals-per-country" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="running-maximum-no.-of-medals-per-country">Running maximum no. of medals per country</h2>
<div>
<p>
Getting the maximum of a country’s earned medals so far helps you determine whether a country has broken its medals record by comparing the current year’s earned medals and the maximum so far.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the year, country, medals, and the maximum medals earned so far for each country, ordered by year in ascending order.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Country_Medals <span class="kw">AS</span> (</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>, Country, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    Country <span class="kw">IN</span> (<span class="st">'CHN'</span>, <span class="st">'KOR'</span>, <span class="st">'JPN'</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span> <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">Year</span>, Country)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Return the max medals earned so far per country</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  country,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  medals,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(medals) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> country</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ASC</span>) <span class="kw">AS</span> Max_Medals</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Country_Medals</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
country
</th>
<th>
medals
</th>
<th>
max_medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
2000
</td>
<td>
CHN
</td>
<td>
39
</td>
<td>
39
</td>
</tr>
<tr>
<td>
2004
</td>
<td>
CHN
</td>
<td>
52
</td>
<td>
52
</td>
</tr>
<tr>
<td>
2008
</td>
<td>
CHN
</td>
<td>
74
</td>
<td>
74
</td>
</tr>
<tr>
<td>
2012
</td>
<td>
CHN
</td>
<td>
56
</td>
<td>
74
</td>
</tr>
</tbody>
</table>
</section>
<section id="running-minimum-number-of-medals" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="running-minimum-number-of-medals">Running minimum number of medals</h2>
<div>
<p>
So far, you’ve seen <code>MAX</code> and <code>SUM</code>, aggregate functions normally used with <code>GROUP BY</code>, being used as window functions. You can also use the other aggregate functions, like <code>MIN</code>, as window functions.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the year, medals earned, and minimum medals earned so far.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb20"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> France_Medals <span class="kw">AS</span> (</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    Country <span class="op">=</span> <span class="st">'FRA'</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span> <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">Year</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  medals,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MIN</span>(medals) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ASC</span>) <span class="kw">AS</span> Min_Medals</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> France_Medals</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
medals
</th>
<th>
min_medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
2000
</td>
<td>
22
</td>
<td>
22
</td>
</tr>
<tr>
<td>
2004
</td>
<td>
21
</td>
<td>
21
</td>
</tr>
<tr>
<td>
2008
</td>
<td>
25
</td>
<td>
21
</td>
</tr>
<tr>
<td>
2012
</td>
<td>
30
</td>
<td>
21
</td>
</tr>
</tbody>
</table>
</section>
<section id="frames-for-windows-functions" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="frames-for-windows-functions">FRAMES for windows functions</h2>
<div>
<p>
Frames allow you to restrict the rows passed as input to your window function to a sliding window for you to define the start and finish.
</p>
<p>
Adding a frame to your window function allows you to calculate “moving” metrics, inputs of which slide from row to row.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the year, medals earned, and the maximum medals earned, comparing only the current year and the next year.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Scandinavian_Medals <span class="kw">AS</span> (</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    Country <span class="kw">IN</span> (<span class="st">'DEN'</span>, <span class="st">'NOR'</span>, <span class="st">'FIN'</span>, <span class="st">'SWE'</span>, <span class="st">'ISL'</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">Year</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Select each year's medals</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  medals,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Get the max of the current and next years'  medals</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(medals) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ASC</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>             <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">current</span> <span class="kw">ROW</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>             <span class="kw">AND</span> <span class="dv">1</span> <span class="kw">following</span>) <span class="kw">AS</span> Max_Medals</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Scandinavian_Medals</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
medals
</th>
<th>
max_medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1896
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
1900
</td>
<td>
1
</td>
<td>
77
</td>
</tr>
<tr>
<td>
1908
</td>
<td>
77
</td>
<td>
141
</td>
</tr>
<tr>
<td>
1912
</td>
<td>
141
</td>
<td>
159
</td>
</tr>
<tr>
<td>
1920
</td>
<td>
159
</td>
<td>
159
</td>
</tr>
<tr>
<td>
1924
</td>
<td>
48
</td>
<td>
48
</td>
</tr>
<tr>
<td>
1928
</td>
<td>
24
</td>
<td>
24
</td>
</tr>
</tbody>
</table>
<p>–</p>
<div>
<p>
Frames allow you to “peek” forwards or backward without first using the relative fetching functions, <code>LAG</code> and <code>LEAD</code>, to fetch previous rows’ values into the current row.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the athletes, medals earned, and the maximum medals earned, comparing only the last two and current athletes, ordering by athletes’ names in alphabetical order.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb22"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Chinese_Medals <span class="kw">AS</span> (</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    Athlete, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    Country <span class="op">=</span> <span class="st">'CHN'</span> <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">2000</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Athlete)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Select the athletes and the medals they've earned</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  athlete,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  medals,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Get the max of the last two and current rows' medals </span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(medals) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> athlete <span class="kw">ASC</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="dv">2</span> <span class="kw">PRECEDING</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span>) <span class="kw">AS</span> Max_Medals</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Chinese_Medals</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Athlete <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
athlete
</th>
<th>
medals
</th>
<th>
max_medals
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
CAI Yalin
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CAI Yun
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CAO Lei
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CAO Yuan
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CHEN Ding
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CHEN Jing
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CHEN Qi
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
CHEN Ruolin
</td>
<td>
4
</td>
<td>
4
</td>
</tr>
</tbody>
</table>
</section>
<section id="moving-average" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="moving-average">Moving average</h2>
<div>
<p>
Using frames with aggregate window functions allow you to calculate many common metrics, including moving averages and totals. These metrics track the change in performance over time.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Calculate the 3-year moving average of medals earned.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb23"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Russian_Medals <span class="kw">AS</span> (</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    Country <span class="op">=</span> <span class="st">'RUS'</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="dt">Year</span> <span class="op">&gt;=</span> <span class="dv">1980</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">Year</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span>, Medals,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">--- Calculate the 3-year moving average of medals earned</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(medals) <span class="kw">OVER</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>     <span class="kw">ROWS</span> <span class="kw">BETWEEN</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>     <span class="dv">2</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span>) <span class="kw">AS</span> Medals_MA</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Russian_Medals</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
medals
</th>
<th>
medals_ma
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
1996
</td>
<td>
36
</td>
<td>
36.0000000000000000
</td>
</tr>
<tr>
<td>
2000
</td>
<td>
66
</td>
<td>
51.0000000000000000
</td>
</tr>
</tbody>
</table>
</section>
<section id="partitioned-moving-total" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="partitioned-moving-total">Partitioned Moving Total</h2>
<div>
<p>
What if your data is split into multiple groups spread over one or more columns in the table? Even with a defined frame, if you can’t somehow separate the groups’ data, one group’s values will affect the average of another group’s values.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Calculate the 3-year moving sum of medals earned per country.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb24"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Country_Medals <span class="kw">AS</span> (</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>, Country, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">Year</span>, Country)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span>, Country, Medals,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Calculate each country's 3-game moving total</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(medals) <span class="kw">OVER</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">PARTITION</span> <span class="kw">BY</span> country</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>     <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Year</span> <span class="kw">ASC</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>     <span class="kw">ROWS</span> <span class="kw">BETWEEN</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>     <span class="dv">2</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span>) <span class="kw">AS</span> Medals_MA</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Country_Medals</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
year
</th>
<th>
country
</th>
<th>
medals
</th>
<th>
medals_ma
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
2008
</td>
<td>
AFG
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
2012
</td>
<td>
AFG
</td>
<td>
1
</td>
<td>
2
</td>
</tr>
<tr>
<td>
1988
</td>
<td>
AHO
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<td>
1984
</td>
<td>
ALG
</td>
<td>
2
</td>
<td>
2
</td>
</tr>
<tr>
<td>
1992
</td>
<td>
ALG
</td>
<td>
2
</td>
<td>
4
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="pivoting" class="level1 page-columns page-full">
<h1>Pivoting</h1>
<section id="basic-pivot" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="basic-pivot">Basic pivot</h2>
<div>
<p>
You have the following table of Pole Vault gold medalist countries by gender in 2008 and 2012.
</p>
<pre><code>| Gender | Year | Country |
|--------|------|---------|
| Men    | 2008 | AUS     |
| Men    | 2012 | FRA     |
| Women  | 2008 | RUS     |
| Women  | 2012 | USA     |
</code></pre>
<p>
Pivot it by <code>Year</code> to get the following reshaped, cleaner table.
</p>
<pre><code>| Gender | 2008 | 2012 |
|--------|------|------|
| Men    | AUS  | FRA  |
| Women  | RUS  | USA  |
</code></pre>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Create the correct extension.
</li>
<li>
Fill in the column names of the pivoted table.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb25"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create the correct extension to enable CROSSTAB</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> tablefunc;</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> CROSSTAB($$</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    Gender, <span class="dt">Year</span>, Country</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span> <span class="kw">IN</span> (<span class="dv">2008</span>, <span class="dv">2012</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Event <span class="op">=</span> <span class="st">'Pole Vault'</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">By</span> Gender <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fill in the correct column names for the pivoted table</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>$$) <span class="kw">AS</span> ct (Gender <span class="dt">VARCHAR</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>           <span class="ot">"2008"</span> <span class="dt">VARCHAR</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>           <span class="ot">"2012"</span> <span class="dt">VARCHAR</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> ct.Gender <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
Gender
</th>
<th>
2008
</th>
<th>
2012
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Men
</td>
<td>
AUS
</td>
<td>
FRA
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
RUS
</td>
<td>
USA
</td>
</tr>
</tbody>
</table>
</section>
<section id="pivot-with-ranking" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="pivot-with-ranking">Pivot with ranking</h2>
<div>
<p>
You want to produce an easy scannable table of the rankings of the three most populous EU countries by how many gold medals they’ve earned in the 2004 through 2012 Olympic games. The table needs to be in this format:
</p>
<pre><code>| Country | 2004 | 2008 | 2012 |
|---------|------|------|------|
| FRA     | ...  | ...  | ...  |
| GBR     | ...  | ...  | ...  |
| GER     | ...  | ...  | ...  |
</code></pre>
<p>
You’ll need to count the gold medals each country has earned, produce the ranks of each country by medals earned, then pivot the table to this shape.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Count the gold medals that France (<code>FRA</code>), the UK (<code>GBR</code>), and Germany (<code>GER</code>) have earned per country and year.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb26"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Count the gold medals per country and year</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  Country,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Awards</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  Country <span class="kw">IN</span> (<span class="st">'FRA'</span>, <span class="st">'GBR'</span>, <span class="st">'GER'</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> <span class="dt">Year</span> <span class="kw">IN</span> (<span class="dv">2004</span>, <span class="dv">2008</span>, <span class="dv">2012</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> Country, <span class="dt">year</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
year
</th>
<th>
awards
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
FRA
</td>
<td>
2004
</td>
<td>
21
</td>
</tr>
<tr>
<td>
FRA
</td>
<td>
2008
</td>
<td>
25
</td>
</tr>
<tr>
<td>
FRA
</td>
<td>
2012
</td>
<td>
30
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
2004
</td>
<td>
17
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
2008
</td>
<td>
31
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
2012
</td>
<td>
48
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
2004
</td>
<td>
41
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
2008
</td>
<td>
42
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
2012
</td>
<td>
45
</td>
</tr>
</tbody>
</table>
<hr>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Select the country and year columns, then rank the three countries by how many gold medals they earned per year.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb27"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Country_Awards <span class="kw">AS</span> (</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    Country,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Awards</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    Country <span class="kw">IN</span> (<span class="st">'FRA'</span>, <span class="st">'GBR'</span>, <span class="st">'GER'</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> <span class="dt">Year</span> <span class="kw">IN</span> (<span class="dv">2004</span>, <span class="dv">2008</span>, <span class="dv">2012</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Country, <span class="dt">Year</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Select Country and Year</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  Country,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Rank by gold medals earned per year</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RANK</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ORDER</span> <span class="kw">BY</span> Awards <span class="kw">DESC</span>) :: <span class="dt">INTEGER</span> <span class="kw">AS</span> <span class="fu">rank</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Country_Awards</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
year
</th>
<th>
rank
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
FRA
</td>
<td>
2004
</td>
<td>
2
</td>
</tr>
<tr>
<td>
FRA
</td>
<td>
2008
</td>
<td>
3
</td>
</tr>
<tr>
<td>
FRA
</td>
<td>
2012
</td>
<td>
3
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
2004
</td>
<td>
3
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
2008
</td>
<td>
2
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
2012
</td>
<td>
1
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
2004
</td>
<td>
1
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
2008
</td>
<td>
1
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
2012
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
<hr>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Pivot the query’s results by <code>Year</code> by filling in the new table’s correct column names.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb28"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> tablefunc;</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> CROSSTAB($$</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span> Country_Awards <span class="kw">AS</span> (</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>      Country,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Year</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Awards</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      Country <span class="kw">IN</span> (<span class="st">'FRA'</span>, <span class="st">'GBR'</span>, <span class="st">'GER'</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">AND</span> <span class="dt">Year</span> <span class="kw">IN</span> (<span class="dv">2004</span>, <span class="dv">2008</span>, <span class="dv">2012</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> Country, <span class="dt">Year</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    Country,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Year</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">RANK</span>() <span class="kw">OVER</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="dt">Year</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>       <span class="kw">ORDER</span> <span class="kw">BY</span> Awards <span class="kw">DESC</span>) :: <span class="dt">INTEGER</span> <span class="kw">AS</span> <span class="fu">rank</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Country_Awards</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, <span class="dt">Year</span> <span class="kw">ASC</span>;</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fill in the correct column names for the pivoted table</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>$$) <span class="kw">AS</span> ct (Country <span class="dt">VARCHAR</span>,</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>           <span class="ot">"2004"</span> <span class="dt">INTEGER</span>,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>           <span class="ot">"2008"</span> <span class="dt">INTEGER</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>           <span class="ot">"2012"</span> <span class="dt">INTEGER</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="kw">Order</span> <span class="kw">by</span> Country <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
2004
</th>
<th>
2008
</th>
<th>
2012
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
FRA
</td>
<td>
2
</td>
<td>
3
</td>
<td>
3
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
3
</td>
<td>
2
</td>
<td>
1
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
1
</td>
<td>
1
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="include-totals-and-grand-totals---rollup-and-cube" class="level1 page-columns page-full">
<h1>Include Totals and Grand Totals - ROLLUP and CUBE</h1>
<section id="rollup" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="rollup">ROLLUP</h2>
<div>
<p>
You want to look at three Scandinavian countries’ earned gold medals per country and gender in the year 2004. You’re also interested in <code>Country</code>-level subtotals to get the total medals earned for each country, but <code>Gender</code>-level subtotals don’t make much sense in this case, so disregard them.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Count the gold medals awarded per country and gender.
</li>
<li>
Generate <code>Country</code>-level gold award counts.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb29"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Count the gold medals per country and gender</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  Country,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  Gender,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Gold_Awards</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span> <span class="op">=</span> <span class="dv">2004</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> Country <span class="kw">IN</span> (<span class="st">'DEN'</span>, <span class="st">'NOR'</span>, <span class="st">'SWE'</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Generate Country-level subtotals</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> Country, <span class="kw">ROLLUP</span>(Gender)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, Gender <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
gender
</th>
<th>
gold_awards
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
DEN
</td>
<td>
Men
</td>
<td>
4
</td>
</tr>
<tr>
<td>
DEN
</td>
<td>
Women
</td>
<td>
15
</td>
</tr>
<tr>
<td>
DEN
</td>
<td>
null
</td>
<td>
19
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
Men
</td>
<td>
3
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
Women
</td>
<td>
2
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
null
</td>
<td>
5
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
Men
</td>
<td>
4
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
Women
</td>
<td>
1
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
null
</td>
<td>
5
</td>
</tr>
</tbody>
</table>
</section>
<section id="cube" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="cube">CUBE</h2>
<div>
<p>
You want to break down all medals awarded to Russia in the 2012 Olympic games per gender and medal type. Since the medals all belong to one country, Russia, it makes sense to generate all possible subtotals (<code>Gender</code>- and <code>Medal</code>-level subtotals), as well as a grand total.
</p>
<p>
Generate a breakdown of the medals awarded to Russia per country and medal type, including all group-level subtotals and a grand total.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Count the medals awarded per gender and medal type.
</li>
<li>
Generate all possible group-level counts (per gender and medal type subtotals and the grand total).
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb30"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Count the medals per gender and medal type</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  Gender,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  medal,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Awards</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span> <span class="op">=</span> <span class="dv">2012</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> Country <span class="op">=</span> <span class="st">'RUS'</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- Get all possible group-level subtotals</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">CUBE</span>(Gender, medal)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Gender <span class="kw">ASC</span>, Medal <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
gender
</th>
<th>
medal
</th>
<th>
awards
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Men
</td>
<td>
Bronze
</td>
<td>
34
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
Gold
</td>
<td>
23
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
Silver
</td>
<td>
7
</td>
</tr>
<tr>
<td>
Men
</td>
<td>
null
</td>
<td>
64
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
Bronze
</td>
<td>
17
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
Gold
</td>
<td>
24
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
Silver
</td>
<td>
25
</td>
</tr>
<tr>
<td>
Women
</td>
<td>
null
</td>
<td>
66
</td>
</tr>
<tr>
<td>
null
</td>
<td>
Bronze
</td>
<td>
51
</td>
</tr>
<tr>
<td>
null
</td>
<td>
Gold
</td>
<td>
47
</td>
</tr>
<tr>
<td>
null
</td>
<td>
Silver
</td>
<td>
32
</td>
</tr>
<tr>
<td>
null
</td>
<td>
null
</td>
<td>
130
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="replace-nulls" class="level1 page-columns page-full">
<h1>Replace nulls</h1>
<div>
<p>
Returning to the breakdown of Scandinavian awards you previously made, you want to clean up the results by replacing the <code>null</code>s with meaningful text.
</p>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Turn the <code>null</code>s in the <code>Country</code> column to <code>All countries</code>, and the <code>null</code>s in the <code>Gender</code> column to <code>All genders</code>.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb31"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Replace the nulls in the columns with meaningful text</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COALESCE</span>(Country, <span class="st">'All countries'</span>) <span class="kw">AS</span> Country,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COALESCE</span>(Gender, <span class="st">'All genders'</span>) <span class="kw">AS</span> Gender,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Awards</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Summer_Medals</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Year</span> <span class="op">=</span> <span class="dv">2004</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> Country <span class="kw">IN</span> (<span class="st">'DEN'</span>, <span class="st">'NOR'</span>, <span class="st">'SWE'</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span>(Country, Gender)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> Country <span class="kw">ASC</span>, Gender <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
gender
</th>
<th>
awards
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
All countries
</td>
<td>
All genders
</td>
<td>
29
</td>
</tr>
<tr>
<td>
DEN
</td>
<td>
All genders
</td>
<td>
19
</td>
</tr>
<tr>
<td>
DEN
</td>
<td>
Men
</td>
<td>
4
</td>
</tr>
<tr>
<td>
DEN
</td>
<td>
Women
</td>
<td>
15
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
All genders
</td>
<td>
5
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
Men
</td>
<td>
3
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
Women
</td>
<td>
2
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
All genders
</td>
<td>
5
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
Men
</td>
<td>
4
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
Women
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
</section>
<section id="compressing-query-output" class="level1 page-columns page-full">
<h1>Compressing Query output</h1>
<div>
<p>
After ranking each country in the 2000 Olympics by gold medals awarded, you want to return the top 3 countries in one row, as a comma-separated string. In other words, turn this:
</p>
<pre><code>| Country | Rank |
|---------|------|
| USA     | 1    |
| RUS     | 2    |
| AUS     | 3    |
| ...     | ...  |
</code></pre>
<p>
into this:
</p>
<pre><code>USA, RUS, AUS
</code></pre>
</div>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Rank countries by the medals they’ve been awarded.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb32"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Country_Medals <span class="kw">AS</span> (</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    Country,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">Year</span> <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Country)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    Country,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Rank countries by the medals awarded</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">RANK</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>) <span class="kw">AS</span> <span class="fu">Rank</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Country_Medals</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">Rank</span> <span class="kw">ASC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
country
</th>
<th>
rank
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
USA
</td>
<td>
1
</td>
</tr>
<tr>
<td>
RUS
</td>
<td>
2
</td>
</tr>
<tr>
<td>
AUS
</td>
<td>
3
</td>
</tr>
<tr>
<td>
CHN
</td>
<td>
4
</td>
</tr>
<tr>
<td>
GER
</td>
<td>
5
</td>
</tr>
<tr>
<td>
ROU
</td>
<td>
6
</td>
</tr>
<tr>
<td>
NED
</td>
<td>
6
</td>
</tr>
<tr>
<td>
HUN
</td>
<td>
8
</td>
</tr>
<tr>
<td>
ITA
</td>
<td>
9
</td>
</tr>
<tr>
<td>
CUB
</td>
<td>
9
</td>
</tr>
<tr>
<td>
GBR
</td>
<td>
9
</td>
</tr>
<tr>
<td>
FRA
</td>
<td>
9
</td>
</tr>
<tr>
<td>
NOR
</td>
<td>
13
</td>
</tr>
<tr>
<td>
DEN
</td>
<td>
14
</td>
</tr>
<tr>
<td>
CMR
</td>
<td>
14
</td>
</tr>
<tr>
<td>
KOR
</td>
<td>
16
</td>
</tr>
<tr>
<td>
YUG
</td>
<td>
16
</td>
</tr>
<tr>
<td>
POL
</td>
<td>
18
</td>
</tr>
<tr>
<td>
BAH
</td>
<td>
19
</td>
</tr>
<tr>
<td>
BUL
</td>
<td>
20
</td>
</tr>
<tr>
<td>
JPN
</td>
<td>
20
</td>
</tr>
<tr>
<td>
ETH
</td>
<td>
22
</td>
</tr>
<tr>
<td>
GRE
</td>
<td>
22
</td>
</tr>
<tr>
<td>
SWE
</td>
<td>
22
</td>
</tr>
<tr>
<td>
CAN
</td>
<td>
22
</td>
</tr>
<tr>
<td>
FIN
</td>
<td>
26
</td>
</tr>
<tr>
<td>
UKR
</td>
<td>
26
</td>
</tr>
<tr>
<td>
TUR
</td>
<td>
26
</td>
</tr>
<tr>
<td>
SLO
</td>
<td>
26
</td>
</tr>
<tr>
<td>
IRI
</td>
<td>
26
</td>
</tr>
<tr>
<td>
AUT
</td>
<td>
26
</td>
</tr>
<tr>
<td>
BLR
</td>
<td>
26
</td>
</tr>
<tr>
<td>
ESP
</td>
<td>
26
</td>
</tr>
<tr>
<td>
KAZ
</td>
<td>
26
</td>
</tr>
<tr>
<td>
SVK
</td>
<td>
35
</td>
</tr>
<tr>
<td>
CZE
</td>
<td>
35
</td>
</tr>
<tr>
<td>
INA
</td>
<td>
35
</td>
</tr>
<tr>
<td>
AZE
</td>
<td>
35
</td>
</tr>
<tr>
<td>
KEN
</td>
<td>
35
</td>
</tr>
<tr>
<td>
LTU
</td>
<td>
35
</td>
</tr>
<tr>
<td>
EST
</td>
<td>
41
</td>
</tr>
<tr>
<td>
THA
</td>
<td>
41
</td>
</tr>
<tr>
<td>
COL
</td>
<td>
41
</td>
</tr>
<tr>
<td>
NZL
</td>
<td>
41
</td>
</tr>
<tr>
<td>
MEX
</td>
<td>
41
</td>
</tr>
<tr>
<td>
LAT
</td>
<td>
41
</td>
</tr>
<tr>
<td>
UZB
</td>
<td>
41
</td>
</tr>
<tr>
<td>
MOZ
</td>
<td>
41
</td>
</tr>
<tr>
<td>
SUI
</td>
<td>
41
</td>
</tr>
<tr>
<td>
ALG
</td>
<td>
41
</td>
</tr>
<tr>
<td>
CRO
</td>
<td>
41
</td>
</tr>
</tbody>
</table>
<hr>
<div class="columns column-page-right">
<div class="instrcol column">
<ul>
<li>
Return the top 3 countries by medals awarded as one comma-separated string.
</li>
</ul>
</div><div class="sepcol column">

</div><div class="column codecol">
<div class="sourceCode" id="cb33"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Country_Medals <span class="kw">AS</span> (</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    Country,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> Medals</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Summer_Medals</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">Year</span> <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AND</span> Medal <span class="op">=</span> <span class="st">'Gold'</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> Country),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  Country_Ranks <span class="kw">AS</span> (</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    Country,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> Medals <span class="kw">DESC</span>) <span class="kw">AS</span> <span class="fu">Rank</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Country_Medals</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">Rank</span> <span class="kw">ASC</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- Compress the countries column</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> STRING_AGG(Country, <span class="st">', '</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Country_Ranks</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Select only the top three ranks</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="fu">Rank</span> <span class="op">&lt;=</span> <span class="dv">3</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<table class="table table-condensed table-bordered table-hover table-striped">
<thead>
<tr>
<th>
string_agg
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
USA, RUS, AUS
</td>
</tr>
</tbody>
</table>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>